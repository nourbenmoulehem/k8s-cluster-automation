---
# ============================================
# K8s Master Role - Initialize Cluster
# Runs ONLY on master node
# ============================================

# --------------------------------------------------
# SECTION 1: CLUSTER INITIALIZATION
# --------------------------------------------------

- name: Check if Kubernetes is already initialized
  stat:
    path: /etc/kubernetes/admin.conf
  register: k8s_init_stat
  tags: [k8s-master, init]

- name: Initialize Kubernetes cluster with kubeadm
  command: kubeadm init --pod-network-cidr=10.244.0.0/16
  when: not k8s_init_stat.stat.exists
  register: kubeadm_init_output
  tags: [k8s-master, init]

# --------------------------------------------------
# SECTION 2: KUBECTL ACCESS SETUP
# --------------------------------------------------

- name: Create .kube directory
  file:
    path: /home/{{ ansible_user }}/.kube
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  tags: [k8s-master, config]

- name: Copy admin.conf to user's kube config
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/{{ ansible_user }}/.kube/config
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
    remote_src: yes
  tags: [k8s-master, config]

# --------------------------------------------------
# SECTION 3: CNI (CALICO) INSTALLATION
# --------------------------------------------------

- name: Check if Calico is installed
  become: no
  shell: kubectl get daemonset calico-node -n kube-system
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  register: calico_check
  failed_when: false
  changed_when: false
  tags: [k8s-master, cni]

- name: Install Calico network plugin
  become: no
  command: kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/calico.yaml
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  when: calico_check.rc != 0
  register: calico_installed
  tags: [k8s-master, cni]

- name: Wait for Calico pods to start
  become: no
  command: kubectl wait --for=condition=Ready pod -l k8s-app=calico-node -n kube-system --timeout=120s
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  when: calico_installed.changed
  retries: 3
  delay: 10
  register: calico_initial_ready
  until: calico_initial_ready.rc == 0
  tags: [k8s-master, cni]

- name: Wait for Calico IP pool to be created
  become: no
  shell: kubectl get ippool default-ipv4-ippool 2>/dev/null
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  when: calico_installed.changed
  retries: 12
  delay: 5
  register: ippool_exists
  until: ippool_exists.rc == 0
  tags: [k8s-master, cni]

- name: Switch Calico from IPIP to VXLAN for OpenStack compatibility
  become: no
  command: kubectl patch ippool default-ipv4-ippool --type merge -p '{"spec":{"ipipMode":"Never","vxlanMode":"Always"}}'
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  when: calico_installed.changed
  register: calico_vxlan_enabled
  tags: [k8s-master, cni]

- name: Restart Calico to apply VXLAN mode
  become: no
  command: kubectl rollout restart daemonset/calico-node -n kube-system
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  when: calico_vxlan_enabled.changed
  tags: [k8s-master, cni]

- name: Wait for Calico with VXLAN to be ready
  become: no
  command: kubectl rollout status daemonset/calico-node -n kube-system --timeout=120s
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  when: calico_vxlan_enabled.changed
  retries: 2
  delay: 10
  register: calico_vxlan_ready
  until: calico_vxlan_ready.rc == 0
  tags: [k8s-master, cni]

- name: Check if kubelet has CNI errors
  shell: journalctl -u kubelet -n 20 --no-pager | grep -q "cni plugin not initialized"
  register: kubelet_cni_error
  failed_when: false
  changed_when: false
  tags: [k8s-master, cni]

- name: Restart kubelet if CNI errors exist
  systemd:
    name: kubelet
    state: restarted
  when: kubelet_cni_error.rc == 0
  tags: [k8s-master, cni]

- name: Wait for kubelet to stabilize
  pause:
    seconds: 10
  when: kubelet_cni_error.rc == 0
  tags: [k8s-master, cni]

# --------------------------------------------------
# SECTION 3.5: REMOVE TAINTS (BEFORE STORAGE!)
# --------------------------------------------------

- name: Remove control-plane taint to allow scheduling
  become: no
  shell: |
    kubectl taint nodes --all node-role.kubernetes.io/control-plane:NoSchedule- 2>/dev/null || true
    kubectl taint nodes --all node.kubernetes.io/not-ready:NoSchedule- 2>/dev/null || true
    kubectl taint nodes --all node.kubernetes.io/not-ready:NoExecute- 2>/dev/null || true
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  tags: [k8s-master, taint]

- name: Wait for node to be schedulable
  pause:
    seconds: 5
  tags: [k8s-master, taint]

# --------------------------------------------------
# SECTION 4: STORAGE PROVISIONER (AFTER TAINT REMOVAL!)
# --------------------------------------------------

- name: Check if local-path-provisioner is installed
  command: kubectl get namespace local-path-storage
  register: local_path_check
  failed_when: false
  changed_when: false
  become: no
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  tags: [k8s-master, storage]

- name: Install local-path storage provisioner
  command: kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.24/deploy/local-path-storage.yaml
  when: local_path_check.rc != 0
  become: no
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  register: local_path_installed
  tags: [k8s-master, storage]

- name: Wait for local-path provisioner to be ready
  command: kubectl wait --for=condition=Ready pod -l app=local-path-provisioner -n local-path-storage --timeout=60s
  when: local_path_installed.changed
  become: no
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  retries: 2
  delay: 5
  register: provisioner_ready
  until: provisioner_ready.rc == 0
  ignore_errors: yes
  tags: [k8s-master, storage]

- name: Display storage provisioner status
  debug:
    msg: "✓ Local-path storage provisioner installed and ready"
  when: provisioner_ready.rc == 0
  tags: [k8s-master, storage]

# --------------------------------------------------
# SECTION 5: WAIT FOR CORE DNS
# --------------------------------------------------

- name: Wait for CoreDNS to be ready
  become: no
  command: kubectl wait --for=condition=Ready pod -l k8s-app=kube-dns -n kube-system --timeout=120s
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  retries: 2
  delay: 10
  register: coredns_ready
  until: coredns_ready.rc == 0
  tags: [k8s-master, dns]

- name: Wait for all system pods to be ready
  become: no
  shell: kubectl wait --for=condition=Ready pods --all -n kube-system --timeout=180s
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  retries: 3
  delay: 10
  register: pods_ready
  until: pods_ready.rc == 0
  ignore_errors: yes
  tags: [k8s-master, cni]

# --------------------------------------------------
# SECTION 6: JOIN COMMAND GENERATION
# --------------------------------------------------

- name: Generate kubeadm join command
  command: kubeadm token create --print-join-command
  register: join_command_output
  tags: [k8s-master, join]

- name: Save join command to project directory
  become: no
  local_action:
    module: copy
    content: "{{ join_command_output.stdout }}"
    dest: "{{ playbook_dir }}/k8s-join-command.sh"
    mode: '0755'
    force: yes
  tags: [k8s-master, join]

# --------------------------------------------------
# SECTION 7: CLUSTER VERIFICATION
# --------------------------------------------------

- name: Get cluster info
  become: no
  command: kubectl cluster-info
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  register: cluster_info
  changed_when: false
  tags: [k8s-master, verify]

- name: Get nodes status
  become: no
  command: kubectl get nodes -o wide
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  register: nodes_status
  changed_when: false
  tags: [k8s-master, verify]

- name: Get all system pods status
  become: no
  command: kubectl get pods -n kube-system -o wide
  environment:
    KUBECONFIG: /home/{{ ansible_user }}/.kube/config
  register: system_pods
  changed_when: false
  tags: [k8s-master, verify]

- name: Display cluster status
  debug:
    msg:
      - "============================================"
      - "✓ Cluster initialized successfully!"
      - "============================================"
      - ""
      - "Cluster Info:"
      - "{{ cluster_info.stdout }}"
      - ""
      - "Nodes:"
      - "{{ nodes_status.stdout }}"
      - ""
      - "System Pods:"
      - "{{ system_pods.stdout }}"
      - ""
      - "Join command: {{ playbook_dir }}/k8s-join-command.sh"
      - "Master is schedulable (taints removed)"
      - "Calico using VXLAN for OpenStack compatibility"
  tags: [k8s-master, verify]
